<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MediStore - Add Product</title>
</head>
<body>
  <script>
    const REGEX = {
      name: /^[A-Za-z0-9 \-\&\(\)\.]{2,100}$/,
      price: /^(?:\d+)(?:\.\d{1,2})?$/,
      qty: /^\d{1,7}$/
    };

    function validateForm(fields) {
      const errors = [];
      if (!REGEX.name.test(fields.name)) errors.push('Invalid product name.');
      if (!REGEX.price.test(String(fields.price))) errors.push('Invalid price format.');
      if (!REGEX.qty.test(String(fields.qty))) errors.push('Invalid quantity.');
      if (!fields.category) errors.push('Please select a category.');
      if (!fields.description || fields.description.length < 3) errors.push('Description is too short.');
      return errors;
    }

    async function addProduct() {
      const name = document.getElementById('name').value.trim();
      const price = document.getElementById('price').value.trim();
      const qty = document.getElementById('qty').value.trim();
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value.trim();
      const imageInput = document.getElementById('image');

      const errors = validateForm({ name, price, qty, category, description });
      if (errors.length) {
        alert('Please fix:\n- ' + errors.join('\n- '));
        return;
      }

      const formData = new FormData();
      formData.append('name', name);
      formData.append('price', price);
      formData.append('qty', qty);
      formData.append('category', category);
      formData.append('description', description);
      if (imageInput.files[0]) {
        formData.append('image', imageInput.files[0]);
      }

      try {
        const res = await fetch('../../Backend/admin/add_product.php', { method: 'POST', body: formData })
        const data = await res.json();
        // ✅ Use "msg" instead of "message"
        alert(data.msg || 'Request completed');
        if (data.success) {
          window.location.href = './view_product.html';
        }
      } catch (e) {
        console.error(e);
        alert('❌ Network error');
      }
    }

    async function mountMasterAndContent() {
      const res = await fetch('./master_template.html');
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      document.documentElement.innerHTML = doc.documentElement.innerHTML;

      document.getElementById('sectionTitle').innerText = 'Add New Product';

      const content = `
        <div id="addProductSection">
          <div class="custom-card p-4">
            <input type="text" id="name" class="form-control mb-3" placeholder="Product Name">
            <input type="number" step="0.01" id="price" class="form-control mb-3" placeholder="Product Price">
            <input type="number" id="qty" class="form-control mb-3" placeholder="Quantity">
            <select id="category" class="form-control mb-3">
              <option value="">Select Category</option>
              <option value="Tablets">Tablets</option>
              <option value="Suspensions">Suspensions</option>
              <option value="Injections">Injections</option>
              <option value="Others">Others</option>
            </select>
            <textarea id="description" class="form-control mb-3" placeholder="Description"></textarea>
            <input type="file" id="image" class="form-control mb-4" accept="image/*">

            <a href="./view_product.html" class="btn btn-secondary">Cancel</a>
            <button class="btn btn-main" id="addProductBtn">Add Product</button>
          </div>
        </div>
      `;
      document.getElementById('pageContent').innerHTML = content;

      document.getElementById('addProductBtn').addEventListener('click', addProduct);
    }

    mountMasterAndContent();
  </script>
</body>
</html>
